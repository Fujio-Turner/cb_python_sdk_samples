from datetime import timedelta
from couchbase.cluster import Cluster
from couchbase.auth import PasswordAuthenticator
from couchbase.options import ClusterOptions, SearchOptions
from couchbase.vector_search import VectorQuery, VectorSearch
import json

# --------------------------------------------------------------
# 1. Connect to the cluster
# --------------------------------------------------------------
cluster = Cluster(
    "couchbase://localhost",  # or your cluster endpoint
    ClusterOptions(PasswordAuthenticator("Administrator", "password"))
)
cluster.wait_until_ready(timedelta(seconds=10))

bucket = cluster.bucket("cake")
scope = bucket.scope("us")
collection = scope.collection("orders")  # not used directly for FTS

# --------------------------------------------------------------
# 2. The 128-dim query vector (Belgium)
# --------------------------------------------------------------
query_vector = [
    0.307843137254902, 0.40588235294117647, 0.4117647058823529, 0.1803921568627451,
    0.12941176470588237, 0.32745098039215687, 0.4137254901960784, 0.43529411764705883,
    0.2803921568627451, 0.14901960784313725, 0.2607843137254902, 0.40980392156862744,
    0.43333333333333335, 0.4019607843137255, 0.1803921568627451, 0.12941176470588237,
    0.35294117647058826, 0.4549019607843137, 0.4235294117647059, 0.4372549019607843,
    0.15294117647058825, 0.12941176470588237, 0.4372549019607843, 0.44901960784313727,
    0.4019607843137255, 0.43333333333333335, 0.43333333333333335, 0.1803921568627451,
    0.1588235294117647, 0.2, 0.22156862745098038, 0.20392156862745098,
    0.18627450980392157, 0.12941176470588237, 0.4137254901960784, 0.38823529411764707,
    0.1803921568627451, 0.1627450980392157, 0.1980392156862745, 0.20784313725490197,
    0.14901960784313725, 0.2607843137254902, 0.45294117647058824, 0.4215686274509804,
    0.40980392156862744, 0.30392156862745096, 0.17647058823529413, 0.2019607843137255,
    0.45294117647058824, 0.28431372549019607, 0.14901960784313725, 0.2784313725490196,
    0.40588235294117647, 0.43137254901960786, 0.39215686274509803, 0.4235294117647059,
    0.1803921568627451, 0.2411764705882353, 0.20392156862745098, 0.40980392156862744,
    0.4196078431372549, 0.4294117647058823, 0.15294117647058825, 0.12941176470588237,
    0.3607843137254902, 0.4137254901960784, 0.3980392156862745, 0.15294117647058825,
    0.12941176470588237, 0.33725490196078434, 0.4372549019607843, 0.40588235294117647,
    0.24901960784313726, 0.14901960784313725, 0.2901960784313726, 0.4,
    0.4235294117647059, 0.2823529411764706, 0.17647058823529413, 0.2019607843137255,
    0.45294117647058824, 0.4372549019607843, 0.2647058823529412, 0.14901960784313725,
    0.29215686274509806, 0.4215686274509804, 0.4215686274509804, 0.40784313725490196,
    0.43333333333333335, 0.1803921568627451, 0.12941176470588237, 0.3686274509803922,
    0.45294117647058824, 0.4215686274509804, 0.2784313725490196, 0.36470588235294116,
    0.4411764705882353, 0.4176470588235294, 0.15294117647058825, 0.12941176470588237,
    0.4117647058823529, 0.39215686274509803, 0.1803921568627451, 0.12941176470588237,
    0.43137254901960786, 0.4470588235294118, 0.3392156862745098, 0.1843137254901961,
    0.44901960784313727, 0.4294117647058823, 0.3862745098039216, 0.3235294117647059,
    0.41568627450980394, 0.4196078431372549, 0.3941176470588235, 0.396078431372549,
    0.307843137254902, 0.42549019607843136, 0.3254901960784314, 0.41568627450980394,
    0.42549019607843136, 0.3941176470588235, 0.396078431372549, 0.28627450980392155,
    0.43137254901960786, 0.43137254901960786, 0.4411764705882353, 0.1980392156862745
]

# --------------------------------------------------------------
# 3. Build the vector search query
# --------------------------------------------------------------
vector_query = VectorQuery(
    field="embedding",
    vector=query_vector,
    k=5  # top 5 nearest neighbors
)

search_request = VectorSearch(
    vector_query,
    fields=["*"]
)

# --------------------------------------------------------------
# 4. Execute the FTS vector search
# --------------------------------------------------------------
try:
    result = scope.search(
        index_name="vect",
        search_request=search_request,
        options=SearchOptions(limit=5)
    )

    print("Vector Search Results (Top 5):")
    print("-" * 60)
    for row in result.rows():
        print(f"ID: {row.id}")
        print(f"Score (cosine similarity): {row.score:.6f}")
        print(f"Fields: {json.dumps(row.fields, indent=2)}")
        print("-" * 40)

    # Optional: print metadata
    # print("Metadata:", result.metadata())

except Exception as e:
    print(f"Search failed: {e}")





'''

'''